# 信号：基本概念

## 概念和概述

信号是事件发生时对进程的通知机制。有时也称之为软件中断。信号与硬件中断的相似
之处在于打断了程序执行的正常流程，大多数情况下，无法预测信号到达的精确时间。

一个（具有合适权限的）进程能够向另一进程发送信号。信号的这一用法可作为一种同
步技术，甚至是进程间通信（IPC）的原始形式。进程也可以向自身发送信号。然而，发往进
程的诸多信号，通常都是源于内核。引发内核为进程产生信号的各类事件如下。
1. 硬件发生异常，即硬件检测到一个错误条件并通知内核，随即再由内核发送相应信号
给相关进程。硬件异常的例子包括执行一条异常的机器语言指令，诸如，被 0 除，或
者引用了无法访问的内存区域。
2. 用户键入了能够产生信号的终端特殊字符。其中包括中断字符（通常是 Control-C)、
暂停字符（通常是 Control-Z）。
3. 发生了软件事件。例如，针对文件描述符的输出变为有效，调整了终端窗口大小，定
时器到期，进程执行的 CPU 时间超限，或者该进程的某个子进程退出。

信号分为两大类。
1. 用于内核向进程通知事件，构成所谓的传统信号（标准信号）。
2. 实时信号。

通常情况下一旦内核接下来要调度该进程运行，等待信号会马上送达（或者进程正在运行，会立刻传递信号）。

有时为了确保代码不被传递来的信号打断，可以将信号添加到添加到***进程的信号掩码当中*** ------ 会阻塞这组信号的到达

倘若这组信号属于阻塞之列，那么信号将保持等待状态，直至稍后对其进行解除阻塞（从信号掩码当中移除）
进程可以使用各种系统调用对其信号掩码添加和移除信号。

信号到达后，进程视具体信号执行如下默认操作之一
1. 忽略信号：内核将信号丢弃，进程不做任何响应。这在某些情况下可能会有用，例如，进程可能对某些信号不感兴趣或者对它们进行了特殊处理。

2. 终止进程：有时是指进程异常终止，而不是通过调用exit()函数正常退出。这通常发生在进程遇到致命错误或者收到类似SIGKILL这样的信号时。进程会立即停止执行并退出。

3. 产生核心转储文件，同时停止进程：当进程收到像SIGSEGV（段错误）这样的信号时，操作系统会将进程的当前内存映像保存到核心转储文件中。这个文件可以用于调试，开发人员可以在发生错误时检查进程的状态。

4. 停止进程：暂停进程的执行，但不会终止它。这通常是通过发送SIGSTOP信号来实现的。停止后的进程可以通过发送SIGCONT信号来恢复执行。

5. 于之前暂停后再度恢复进程的执行：如果进程之前被暂停（通过发送SIGSTOP信号），它可以通过发送SIGCONT信号来继续执行。这对于暂时停止进程然后再次启动它是很有用的。


除了根据特定信号采取的默认行为，程序也能改变信号到达时的响应行为。
称之为**对信号的处置设置**。程序可以将对信号的处置设置为如下之一
1. 采取默认行为。适用于撤销信号之前对信号处置的设置
2. 忽略信号。适用于默认行为为终止进程的信号
3. 执行信号处理器程序


信号处理器程序是由程序员编写的函数，用于为响应传递来的信号而执行适当任务。例
如，shell 为 SIGINT 信号（由中断字符串 Control-C 产生）提供了一个处理器程序，令其停止
当前正在执行的工作，并将控制返回到（shell 的）主输入循环，并再次向用户呈现 shell 提示符。
通知内核应当去调用某一处理器程序的行为，通常称之为安装或者建立信号处理器程序。调
用信号处理器程序以响应传递来的信号，则称之为信号已处理（handled），或者已捕获（caught）。

无法将信号处置设置为终止进程或者转储核心（除非这是对信号的默认处置）。
效果最为近似的是为信号安装一个处理器程序，并于其中调用 exit()或者 abort()。
abort()为进程产生一个 SIGABRT 信号，该信号将引发进程转储核心文件并终止。

## 信号类型和默认行为

SIGHUP (1)：

解释：SIGHUP是“Hangup”的缩写，意味着终端挂起或控制进程终止。通常在用户退出终端会话时发送给与终端相关的进程，以通知它们终端会话已经结束。

SIGINT (2)：

解释：SIGINT是“Interrupt”的缩写，用于中断正在运行的进程。通常由用户在终端按下Ctrl+C键触发，以向当前运行的进程发送中断信号，请求其终止执行。

SIGQUIT (3)：

解释：SIGQUIT是“Quit”的缩写，用于终止进程并生成核心转储文件。通常由用户在终端按下Ctrl+\键触发，与SIGINT类似，但会导致进程生成核心转储文件，以便进一步调试。

SIGILL (4)：

解释：SIGILL表示进程执行了非法指令，通常表示进程遇到了无效的机器指令。

SIGTRAP (5)：

解释：SIGTRAP表示跟踪/断点陷阱，通常由调试器用于在进程执行时设置断点或跟踪。

SIGABRT (6)：

解释：SIGABRT表示异常终止请求，通常由abort()函数生成，用于请求进程异常终止并生成核心转储文件。

SIGBUS (7)：

解释：SIGBUS表示进程遇到了总线错误，通常是由于对未对齐内存地址进行读写操作而引起的。

SIGFPE (8)：

解释：SIGFPE表示浮点异常，通常是由于对浮点运算中的非法操作（如除以零）而引起的。

SIGKILL (9)：

解释：SIGKILL是一个无条件终止信号，不能被捕获或忽略，用于强制结束一个进程。

SIGUSR1 (10)：

解释：SIGUSR1和SIGUSR2是两个用户自定义信号，通常由用户程序用于向进程发送自定义通知或命令。

SIGSEGV (11)：

解释：SIGSEGV表示进程尝试访问未分配给它的内存地址，通常称为段错误。

SIGUSR2 (12)：

解释：见SIGUSR1。

SIGPIPE (13)：

解释：SIGPIPE表示管道破裂，通常发生在进程尝试向一个已关闭的管道写入数据时。

SIGALRM (14)：

解释：SIGALRM表示定时器超时，通常用于向进程发送定时提醒或触发操作。

SIGTERM (15)：

解释：SIGTERM是正常终止请求，通常由kill命令或操作系统发出，请求进程正常终止。

SIGSTKFLT (16)：

解释：SIGSTKFLT表示协处理器栈错误。

SIGCHLD (17)：

解释：SIGCHLD表示子进程状态发生改变，通常由操作系统向父进程发送，以通知子进程的终止或停止。

SIGCONT (18)：

解释：SIGCONT表示继续执行已停止的进程，通常由kill命令发送给已暂停的进程，以请求其继续执行。

SIGSTOP (19)：

解释：SIGSTOP用于停止执行进程，类似于SIGKILL，但可以被其他信号（如SIGCONT）重新启动。

SIGTSTP (20)：

解释：SIGTSTP表示停止进程，通常由用户按下Ctrl+Z键触发，将当前运行的进程暂停，并将其置于后台。

SIGTTIN (21)：

解释：SIGTTIN表示后台进程尝试读取控制终端。

SIGTTOU (22)：

解释：SIGTTOU表示后台进程尝试写入控制终端。

SIGURG (23)：

解释：SIGURG表示套接字外带数据可用或紧急情况。

SIGXCPU (24)：

解释：SIGXCPU表示CPU时间限制已超过。

SIGXFSZ (25)：

解释：SIGXFSZ表示文件大小限制已超过。

SIGVTALRM (26)：

解释：SIGVTALRM表示虚拟定时器超时。

SIGPROF (27)：

解释：SIGPROF表示定时器超时。

SIGWINCH (28)：

解释：SIGWINCH表示窗口大小调整。

SIGIO (29)：

解释：SIGIO表示异步I/O事件发生。

SIGPWR (30)：

解释：SIGPWR表示电源故障。

SIGSYS (31)：

解释：SIGSYS表示非法系统调用。


## 改变信号处置：signal()

```c
#include <signal.h>

void ( *signal(int sig, void (*handler)(int)) ) (int);
```

在为 signal()指定 handler 参数时，可以以如下值来代替函数地址：
SIG_DFL 
将信号处置重置为默认值。这适用于将之前 signal()调用所改变的信号处置
还原。
SIG_IGN 
忽略该信号。如果信号专为此进程而生，那么内核会默默将其丢弃。进程甚至从未知道
曾经产生了该信号。
调用 signal()成功将返回先前的信号处置，有可能是先前安装的处理器函数地址，也可能
是常量 SIG_DFL 和 SIG_IGN 之一。如果调用失败，signal()将返回 SIG_ERR。

## 信号处理器简介

信号处理器程序（也称为信号捕捉器）是当指定信号传递给进程时将会调用的一个函数。
调用信号处理器程序，可能会随时打断主程序流程；内核代表进程来调用处理器程序，
当处理器返回时，主程序会在处理器打断的位置恢复执行。
