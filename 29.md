# 线程：介绍

## 概述
线程（thread）是允许应用程序并发执行多个任务的一种机制。
一个进程可以包含多个线程。同一程序中的所有线程均会独立执行相同程序，
且共享同一份全局内存区域，其中包括初始化数据段（initialized data）、未初始化数据段
（uninitialized data），以及堆内存段（heap segment）。

除了全局内存之外，线程还共享了一干其他属性（这些属性对于进程而言是全局性的，
而并非针对某个特定线程），包括以下内容。
y 进程 ID（process ID）和父进程 ID。
y 进程组 ID 与会话 ID（session ID）。
y 控制终端。
y 进程凭证（process credential）（用户 ID 和组 ID ）。
y 打开的文件描述符。
y 由 fcntl()创建的记录锁（record lock）。
y 信号（signal）处置。
y 文件系统的相关信息：文件权限掩码（umask）、当前工作目录和根目录。
y 间隔定时器（setitimer()）和 POSIX 定时器（timer_create()）。
y 系统 V（system V）信号量撤销（undo，semadj）值（47.8 节）。
y 资源限制（resource limit）。
y CPU 时间消耗（由 times()返回）。
y 资源消耗（由 getrusage()返回）。
y nice 值（由 setpriority()和 nice()设置）。
各线程所独有的属性，如下列出了其中一部分。
y 线程 ID（thread ID，29.5 节）。
y 信号掩码（signal mask）。
y 线程特有数据（31.3 节）。
y 备选信号栈（sigaltstack()）。
y errno 变量。
y 浮点型（floating-point）环境（见 fenv(3)）。
y 实时调度策略（real-time scheduling policy）和优先级（35.2 节和 35.3 节）。
y CPU 亲和力（affinity，Linux 所特有，35.4 节将加以描述）。
y 能力（capability，Linux 所特有，第 39 章将加以描述）。
y 栈，本地变量和函数的调用链接（linkage）信息。

## Pthreads API 的详细背景

### 线程数据类型（Pthreads data type）

| 数据类型             | 描述                            |
|---------------------|---------------------------------|
| pthread_t           | 线程 ID                         |
| pthread_mutex_t     | 互斥对象（Mutex）               |
| pthread_mutexattr_t | 互斥属性对象                    |
| pthread_cond_t      | 条件变量（condition variable）  |
| pthread_condattr_t  | 条件变量的属性对象              |
| pthread_key_t       | 线程特有数据的键（Key）         |
| pthread_once_t      | 一次性初始化控制上下文（control context）|
| pthread_attr_t      | 线程的属性对象                  |

### 线程和erron

errno 是一全局整型变量。然而，这无法满足多线程程序的需要。
如果线程调用的函数通过全局 errno 返回错误时，会与其他发起函数调用并检查 errno 的线程
混淆在一起。换言之，这将引发竞争条件（race condition）。因此，在多线程程序中，每个线
程都有属于自己的 errno。

### Pthreads 函数返回值

从系统调用和库函数中返回状态，传统的做法是：返回 0 表示成功，返回-1 表示失败，并设
置 errno 以标识错误原因。Pthreads API 则反其道而行之。所有 Pthreads 函数均以返回 0 表示成功，
返回一正值表示失败。这一失败时的返回值，与传统 UNIX 系统调用置于 errno 中的值含义相同。

```c
pthread_t *thread;
int s;

s = pthread_create(&thread, NULL, ffunc, &arg);
if (s != 0) 
    errExitEN(s, "pthread_create");
```

### 编译 Pthreads 程序

在 Linux 平台上，在编译调用了 Pthreads API 的程序时，需要设置 cc -pthread 的编译选项。
使用该选项的效果如下。
y 定义_REENTRANT 预处理宏。这会公开对少数可重入（reentrant）函数的声明。
y 程序会与库 libpthread 进行链接（等价于-lpthread）